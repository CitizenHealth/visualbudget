"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!==("undefined"==typeof e?"undefined":_typeof(e))&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof e?"undefined":_typeof(e)));t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!==("undefined"==typeof e?"undefined":_typeof(e))&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof e?"undefined":_typeof(e)));t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!==("undefined"==typeof e?"undefined":_typeof(e))&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof e?"undefined":_typeof(e)));t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var n=e[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,a,n){return a&&t(e.prototype,a),n&&t(e,n),e}}(),VbChart=function(){function t(e,a){_classCallCheck(this,t),this.$div=e,this.data=a,this.atts=this.removeVbPrefixesOnAttributes(e.data()),this.state={groups:[],date:"2016",dragging:!1,mouseX:null}}return _createClass(t,[{key:"removeVbPrefixesOnAttributes",value:function(t){function e(t){return t.charAt(0).toLowerCase()+t.slice(1).toLowerCase()}function a(t){return t.replace(/^vb/,"")}var n={};for(var r in t)if(t.hasOwnProperty(r)){var i=a(r);i=e(i),n[i]=t[r]}return n}},{key:"dollarAmountOfDate",value:function(t){for(var e=0;e<this.data.dollarAmounts.length;e++){var a=this.data.dollarAmounts[e];if(a.date==t)return a.dollarAmount}return null}},{key:"setState",value:function(t){this.state=Object.assign({},this.state,t),this.redraw()}},{key:"redraw",value:function(){console.log("Drawing chart "+this.atts.hash+"."),this.$div.html("This is a chart")}},{key:"destroy",value:function(){console.log("Destroying chart "+this.atts.hash+".")}},{key:"getDateRange",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.data,e=[];t.dollarAmounts.forEach(function(t){e.push(Date.parse(t.date))});var a=e.reduce(function(t,e){return Math.min(t,e)}),n=e.reduce(function(t,e){return Math.max(t,e)});return[new Date(a),new Date(n)]}},{key:"nFormat",value:function(t){var e,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=[{value:1e12,symbol:"T"},{value:1e9,symbol:"B"},{value:1e6,symbol:"M"},{value:1e3,symbol:"k"}],r=/\.0+$|(\.[0-9]*[1-9])0+$/;for(e=0;e<n.length;e++)if(t>=n[e].value)return(t/n[e].value).toFixed(a).replace(r,"$1")+n[e].symbol;return t.toFixed(a).replace(r,"$1")}},{key:"getDateIndex",value:function(t){for(var e=0,a=0;a<this.data.dollarAmounts.length;a++)this.data.dollarAmounts[a].date==t&&(e=a);return e}},{key:"findHash",value:function(t,e){var a=null;return e.each(function(e){e.data.hash==t&&(a=e)}),a}}]),t}(),_createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var n=e[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,a,n){return a&&t(e.prototype,a),n&&t(e,n),e}}(),VbLineChart=function(t){function e(t,a){_classCallCheck(this,e),a.dollarAmounts.forEach(function(t){t.dollarAmount=+t.dollarAmount});var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,a));return n.setupChartSvg(),n.addActions(),n}return _inherits(e,t),_createClass(e,[{key:"redraw",value:function(){console.log("Drawing chart "+this.atts.hash+" (linechart)."),d3.selectAll("#"+this.$div.attr("id")+" svg g *").remove(),this.drawChart()}},{key:"setState",value:function(t){this.state=Object.assign({},this.state,t),this.moveHoverline()}},{key:"setupChartSvg",value:function(){var t=this.$div;this.chart={};var e=this.chart.margin={top:30,right:20,bottom:30,left:50},a=this.chart.width=t.width(),n=this.chart.height=t.height();this.chart.xwidth=a-e.right-e.left,this.chart.yheight=n-e.top-e.bottom,this.svg=d3.select(t.get(0)).append("svg").attr("class","svg-chart").attr("width",a).attr("height",n).append("g").attr("transform","translate("+e.left+","+e.top+")")}},{key:"drawChart",value:function(){var t=this,e=this.data,a=this.chart,n=this.svg,r=function(t){return function(t){return!0}},i=(d3.timeFormat("%d-%b-%y").parse,d3.scaleTime().range([0,a.xwidth])),o=d3.scaleLinear().range([a.yheight,0]),l=d3.axisBottom().scale(i),s=d3.axisLeft().scale(o).tickFormat(function(e){return t.nFormat(e,0)}),c=d3.line().x(function(t){return i(new Date(t.date))}).y(function(t){return o(t.dollarAmount)});i.domain(this.getDateRange()),o.domain([0,d3.max(e.dollarAmounts.filter(r(null)),function(t){return t.dollarAmount})]),n.append("path").attr("class","line").attr("d",c(e.dollarAmounts.filter(r(null)))),n.append("g").attr("class","x axis").attr("transform","translate(0,"+a.yheight+")").call(l),n.append("g").attr("class","y axis").call(s),a.x=i,a.y=o,n.append("rect").attr("class","click-capture").style("visibility","hidden").attr("width",a.width).attr("height",a.height);var u=this.chart.x(new Date(this.state.date));this.hoverline=n.append("line").attr("x1",u).attr("x2",u).attr("y1",0).attr("y2",a.yheight).attr("class","hoverline")}},{key:"moveHoverline",value:function(){var t=this.chart.x(new Date(this.state.date));this.hoverline.attr("x1",t).attr("x2",t)}},{key:"addActions",value:function(){function t(t){var e=void 0;return e="touchstart"===t.type?t.touches[0].pageX:t.offsetX||d3.mouse(this)[0],e-r.chart.margin.left}function e(e){e=d3.event,e.preventDefault();var a=t(e),n=r.chart.x.invert(a),i=n.getMonth()<=6?n.getUTCFullYear():n.getUTCFullYear()+1;visualbudget.broadcastStateChange({date:""+i,dragging:!0})}function a(t){r.state.dragging&&e(t)}function n(t){t=d3.event,t.preventDefault(),visualbudget.broadcastStateChange({dragging:!1})}var r=this;this.svg.on("mousedown",e),this.svg.on("mousemove",a),this.svg.on("mouseup",n)}}]),e}(VbChart),_createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var n=e[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,a,n){return a&&t(e.prototype,a),n&&t(e,n),e}}(),VbMetric=function(t){function e(t,a){_classCallCheck(this,e),a.dollarAmounts.forEach(function(t){t.dollarAmount=+t.dollarAmount});var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,a));return t.css({display:"inline"}),n}return _inherits(e,t),_createClass(e,[{key:"redraw",value:function(){var t=this.getMetric(this.atts.metric,this.state);this.$div.html(t)}},{key:"getMetric",value:function(t,e){var a=null;switch(t){case"date":a=e.date;break;case"datetotal":a=this.getMetricYearTotal(e);break;case"average":a=this.getMetricAverage(e);break;case"5yearaverage":a="5-year-average coming soon.";break;default:a="Unrecognized metric."}return a}},{key:"getMetricYearTotal",value:function(t){var e=this.dollarAmountOfDate(t.date);return null===e?"N/A":e="$"+this.nFormat(e,1)}},{key:"getMetricAverage",value:function(t){var e=this.data.dollarAmounts.reduce(function(t,e){return t+e.dollarAmount},0)/this.data.dollarAmounts.length;return e="$"+this.nFormat(e,1)}}]),e}(VbChart),_createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var n=e[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,a,n){return a&&t(e.prototype,a),n&&t(e,n),e}}(),VbTreeMap=function(t){function e(t,a){_classCallCheck(this,e),a.dollarAmounts.forEach(function(t){t.dollarAmount=+t.dollarAmount});var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,a));return n.initialize(t,a),n}return _inherits(e,t),_createClass(e,[{key:"redraw",value:function(){console.log("Drawing chart "+this.atts.hash+" (treemap).")}},{key:"setState",value:function(t){var e=this.state.date,a=t.date;this.state=Object.assign({},this.state,t),a&&a!=e&&(this.dateIndex=this.getDateIndex(this.state.date),this.calculateLayout(),this.open())}},{key:"initialize",value:function(t,e){var a=(d3.select(t.get(0)).classed("vb-treemap",!0),t.width()),n=t.height(),n=n,r=(d3.format(",d"),this.nav=d3.select(t.get(0)).append("svg").attr("width",a).attr("height",n).append("g").style("shape-rendering","crispEdges"));r.x=d3.scaleLinear().domain([0,a]).range([0,a]),r.y=d3.scaleLinear().domain([0,n]).range([0,n]),r.h=n,r.w=a,r.color=d3.schemeCategory20;this.dateIndex=this.getDateIndex(this.state.date);r.selectAll("g").remove(),this.calculateLayout(),r.grandparent=r.append("rect").attr("y","-20px").attr("class","grandparent");var i=document.createElement("p");i.setAttribute("id","vb-zoom-button"),t.get(0).parentNode.insertBefore(i,t.get(0)),d3.select("#vb-zoom-button").text("Zoom out").on("click",function(){r.grandparent.dispatch("click")}),this.currentLevel=this.display(this.currentData)}},{key:"calculateLayout",value:function(){var t=this,e=0,a=function(t){d3.schemeCategory20[e]||(e=0),t.color=d3.schemeCategory20[e],e++};this.root=d3.hierarchy(this.data,function(t){return t.children}).sum(function(e){return e.children.length?0:e.dollarAmounts[t.dateIndex].dollarAmount}).sort(function(t,e){return e.dollarAmount-t.dollarAmount}).each(a),this.treemap=d3.treemap().size([this.$div.width(),this.$div.height()]).padding(0).round(!1),this.treemap(this.root),this.currentData=this.currentData?this.findHash(this.currentData.data.hash,this.root):this.root,this.state.hash=this.currentData.data.hash}},{key:"display",value:function(t){function e(t,e){e.selectAll(".child").data(function(t){return t.children||[t]}).enter().append("g").attr("class","child").each(function(){d3.select(this);if(void 0!==t.children)for(var e=0;e<t.children.length;e++);}).append("rect").call(a.rect(a.nav))}var a=this,n=this.nav,r=(d3.format(",d"),n.insert("g",".grandparent-g").datum(t).attr("class","depth").on("click",function(t){a.zoneClick.call(this,d3.select(this).datum(),!0,null,a)})),i=r.selectAll("g").data(0===t.children.length?[t]:t.children).enter().append("g");n.grandparent.attr("width","100%").attr("height","20px").style("fill","#eaa").datum(void 0===t.parent?t:t.parent).on("click",function(t){a.zoneClick.call(this,d3.select(this).datum(),!0,null,a)}),i.filter(function(t){return t.children}).classed("children",!0).on("click",function(t){a.zoneClick.call(this,d3.select(this).datum(),!0,null,a)}).each(function(){var t=d3.select(this);t.attr("nodeid",function(){return"1"})}),i.append("rect").attr("class","parent").call(a.rect(a.nav)).style("fill",function(t){return t.color}),e(t,i);this.dateIndex;return i.each(function(){d3.select(this).append("foreignObject").call(a.rect(a.nav)).attr("class","foreignobj").append("xhtml:div").html(function(t){var e='<div class="titleLabel">'+t.data.name+"</div>",n='<div class="valueLabel">$'+a.nFormat(t.value)+"</div>";return e+n}).attr("class","textdiv")}),i}},{key:"open",value:function(t,e){this.zoneClick.call(null,this.currentData,!1,e||1,this)}},{key:"zoneClick",value:function(t,e,a,n){var r=n.nav,i=window.event||i;if(i.preventDefault(),a=a||750,!r.transitioning&&t){if(e&&t.data.hash===n.currentData.data.hash)return void r.grandparent.dispatch("click");n.dateIndex;if(0===t.value)return void n.zoneClick.call(null,t.parent||n.root.data.hash,0,n);r.selectAll("text").remove(),n.currentData=t,n.state.hash=t.data.hash,visualbudget.broadcastStateChange(n.state),r.transitioning=!0;var o=n.display(t),l=n.currentLevel.transition().duration(a),s=o.transition().duration(a);r.x.domain([t.x0,t.x1]),r.y.domain([t.y0,t.y1]),r.style("shape-rendering",null),r.selectAll(".depth").sort(function(t,e){return t.depth-e.depth}),o.selectAll(".foreignobj").style("fill-opacity",0),l.style("opacity",0),l.selectAll(".foreignobj").call(n.rect(r)),s.selectAll(".foreignobj").call(n.rect(r)),l.selectAll("rect").call(n.rect(r)),s.selectAll("rect").call(n.rect(r)),l.remove().on("end",function(){r.style("shape-rendering","crispEdges"),r.transitioning=!1}),n.currentLevel=o}}},{key:"rect",value:function(t){return function(e){e.attr("x",function(e){return t.x(e.x0)}).attr("y",function(e){return t.y(e.y0)}).attr("width",function(e){return t.x(e.x1)-t.x(e.x0)}).attr("height",function(e){return t.y(e.y1)-t.y(e.y0)})}}}]),e}(VbChart),visualbudget=function(t,e,a){return t.initialize=function(a){"undefined"==typeof a&&(a=function(){}),console.log("Initializing VB charts."),t.charts=[];var n=e(".vb-chart");e.when.apply(e,n.map(t.tryToInitializeChart)).then(t.drawAllCharts).then(a)},t.tryToInitializeChart=function(){var a=e(this),n=a.data("vbDatasetUrl");if(n){var r=e.getJSON(n).done(t.setupChartObject(a)).fail(function(t,e,a){var n=e+", "+a;console.log("Request Failed: "+n)});return r}},t.setupChartObject=function(e){return function(a){var n;switch(e.data("vbVis")){case"linechart":n=new VbLineChart(e,a);break;case"treemap":n=new VbTreeMap(e,a);break;case"metric":n=new VbMetric(e,a);break;default:console.log("VB error: Unrecognized chart type.")}t.charts.push(n),console.log("Added chart "+n.atts.hash+" to queue.")}},t.drawAllCharts=function(){t.charts.forEach(function(t,e,a){t.redraw()})},t.broadcastStateChange=function(e){for(var a=0;a<t.charts.length;a++)t.charts[a].setState(e)},t.getChart=function(e){for(var a=null,n=0;n<t.charts.length;n++)if(t.charts[n].atts.hash==e){a=t.charts[n];break}return a},t}(visualbudget||{},jQuery,d3);!function(t,e){e(document).ready(function(){t.initialize()})}(visualbudget,jQuery),require("includes/vb-chart");var _createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var n=e[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,a,n){return a&&t(e.prototype,a),n&&t(e,n),e}}(),VbChart=function(){function t(e,a){_classCallCheck(this,t),this.$div=e,this.data=a,this.atts=this.removeVbPrefixesOnAttributes(e.data()),this.state={groups:[],date:"2016",dragging:!1,mouseX:null}}return _createClass(t,[{key:"removeVbPrefixesOnAttributes",value:function(t){function e(t){return t.charAt(0).toLowerCase()+t.slice(1).toLowerCase()}function a(t){return t.replace(/^vb/,"")}var n={};for(var r in t)if(t.hasOwnProperty(r)){var i=a(r);i=e(i),n[i]=t[r]}return n}},{key:"dollarAmountOfDate",value:function(t){for(var e=0;e<this.data.dollarAmounts.length;e++){var a=this.data.dollarAmounts[e];if(a.date==t)return a.dollarAmount}return null}},{key:"setState",value:function(t){this.state=Object.assign({},this.state,t),this.redraw()}},{key:"redraw",value:function(){console.log("Drawing chart "+this.atts.hash+"."),this.$div.html("This is a chart")}},{key:"destroy",value:function(){console.log("Destroying chart "+this.atts.hash+".")}},{key:"getDateRange",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.data,e=[];t.dollarAmounts.forEach(function(t){e.push(Date.parse(t.date))});var a=e.reduce(function(t,e){return Math.min(t,e)}),n=e.reduce(function(t,e){return Math.max(t,e)});return[new Date(a),new Date(n)]}},{key:"nFormat",value:function(t){var e,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=[{value:1e12,symbol:"T"},{value:1e9,symbol:"B"},{value:1e6,symbol:"M"},{value:1e3,symbol:"k"}],r=/\.0+$|(\.[0-9]*[1-9])0+$/;for(e=0;e<n.length;e++)if(t>=n[e].value)return(t/n[e].value).toFixed(a).replace(r,"$1")+n[e].symbol;return t.toFixed(a).replace(r,"$1")}},{key:"getDateIndex",value:function(t){for(var e=0,a=0;a<this.data.dollarAmounts.length;a++)this.data.dollarAmounts[a].date==t&&(e=a);return e}},{key:"findHash",value:function(t,e){var a=null;return e.each(function(e){e.data.hash==t&&(a=e)}),a}}]),t}(),_createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var n=e[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,a,n){return a&&t(e.prototype,a),n&&t(e,n),e}}(),VbLineChart=function(t){function e(t,a){_classCallCheck(this,e),a.dollarAmounts.forEach(function(t){t.dollarAmount=+t.dollarAmount});var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,a));return n.setupChartSvg(),n.addActions(),n}return _inherits(e,t),_createClass(e,[{key:"redraw",value:function(){console.log("Drawing chart "+this.atts.hash+" (linechart)."),d3.selectAll("#"+this.$div.attr("id")+" svg g *").remove(),this.drawChart()}},{key:"setState",value:function(t){this.state=Object.assign({},this.state,t),this.moveHoverline()}},{key:"setupChartSvg",value:function(){var t=this.$div;this.chart={};var e=this.chart.margin={top:30,right:20,bottom:30,left:50},a=this.chart.width=t.width(),n=this.chart.height=t.height();this.chart.xwidth=a-e.right-e.left,this.chart.yheight=n-e.top-e.bottom,this.svg=d3.select(t.get(0)).append("svg").attr("class","svg-chart").attr("width",a).attr("height",n).append("g").attr("transform","translate("+e.left+","+e.top+")")}},{key:"drawChart",value:function(){var t=this,e=this.data,a=this.chart,n=this.svg,r=function(t){return function(t){return!0}},i=(d3.timeFormat("%d-%b-%y").parse,d3.scaleTime().range([0,a.xwidth])),o=d3.scaleLinear().range([a.yheight,0]),l=d3.axisBottom().scale(i),s=d3.axisLeft().scale(o).tickFormat(function(e){return t.nFormat(e,0)}),c=d3.line().x(function(t){return i(new Date(t.date))}).y(function(t){return o(t.dollarAmount)});i.domain(this.getDateRange()),o.domain([0,d3.max(e.dollarAmounts.filter(r(null)),function(t){return t.dollarAmount})]),n.append("path").attr("class","line").attr("d",c(e.dollarAmounts.filter(r(null)))),n.append("g").attr("class","x axis").attr("transform","translate(0,"+a.yheight+")").call(l),n.append("g").attr("class","y axis").call(s),a.x=i,a.y=o,n.append("rect").attr("class","click-capture").style("visibility","hidden").attr("width",a.width).attr("height",a.height);var u=this.chart.x(new Date(this.state.date));this.hoverline=n.append("line").attr("x1",u).attr("x2",u).attr("y1",0).attr("y2",a.yheight).attr("class","hoverline")}},{key:"moveHoverline",value:function(){var t=this.chart.x(new Date(this.state.date));this.hoverline.attr("x1",t).attr("x2",t)}},{key:"addActions",value:function(){function t(t){var e=void 0;return e="touchstart"===t.type?t.touches[0].pageX:t.offsetX||d3.mouse(this)[0],e-r.chart.margin.left}function e(e){e=d3.event,e.preventDefault();var a=t(e),n=r.chart.x.invert(a),i=n.getMonth()<=6?n.getUTCFullYear():n.getUTCFullYear()+1;visualbudget.broadcastStateChange({date:""+i,dragging:!0})}function a(t){r.state.dragging&&e(t)}function n(t){t=d3.event,t.preventDefault(),visualbudget.broadcastStateChange({dragging:!1})}var r=this;this.svg.on("mousedown",e),this.svg.on("mousemove",a),this.svg.on("mouseup",n)}}]),e}(VbChart),_createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var n=e[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,a,n){return a&&t(e.prototype,a),n&&t(e,n),e}}(),VbMetric=function(t){function e(t,a){_classCallCheck(this,e),a.dollarAmounts.forEach(function(t){t.dollarAmount=+t.dollarAmount});var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,a));return t.css({display:"inline"}),n}return _inherits(e,t),_createClass(e,[{key:"redraw",value:function(){var t=this.getMetric(this.atts.metric,this.state);this.$div.html(t)}},{key:"getMetric",value:function(t,e){var a=null;switch(t){case"date":a=e.date;break;case"datetotal":a=this.getMetricYearTotal(e);break;case"average":a=this.getMetricAverage(e);break;case"5yearaverage":a="5-year-average coming soon.";break;default:a="Unrecognized metric."}return a}},{key:"getMetricYearTotal",value:function(t){var e=this.dollarAmountOfDate(t.date);return null===e?"N/A":e="$"+this.nFormat(e,1)}},{key:"getMetricAverage",value:function(t){var e=this.data.dollarAmounts.reduce(function(t,e){return t+e.dollarAmount},0)/this.data.dollarAmounts.length;return e="$"+this.nFormat(e,1)}}]),e}(VbChart),_createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var n=e[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,a,n){return a&&t(e.prototype,a),n&&t(e,n),e}}(),VbTreeMap=function(t){function e(t,a){_classCallCheck(this,e),a.dollarAmounts.forEach(function(t){t.dollarAmount=+t.dollarAmount});var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,a));return n.initialize(t,a),n}return _inherits(e,t),_createClass(e,[{key:"redraw",value:function(){console.log("Drawing chart "+this.atts.hash+" (treemap).")}},{key:"setState",value:function(t){var e=this.state.date,a=t.date;this.state=Object.assign({},this.state,t),a&&a!=e&&(this.dateIndex=this.getDateIndex(this.state.date),this.calculateLayout(),this.open())}},{key:"initialize",value:function(t,e){var a=(d3.select(t.get(0)).classed("vb-treemap",!0),t.width()),n=t.height(),n=n,r=(d3.format(",d"),this.nav=d3.select(t.get(0)).append("svg").attr("width",a).attr("height",n).append("g").style("shape-rendering","crispEdges"));r.x=d3.scaleLinear().domain([0,a]).range([0,a]),r.y=d3.scaleLinear().domain([0,n]).range([0,n]),r.h=n,r.w=a,r.color=d3.schemeCategory20;this.dateIndex=this.getDateIndex(this.state.date);r.selectAll("g").remove(),this.calculateLayout(),r.grandparent=r.append("rect").attr("y","-20px").attr("class","grandparent");var i=document.createElement("p");i.setAttribute("id","vb-zoom-button"),t.get(0).parentNode.insertBefore(i,t.get(0)),d3.select("#vb-zoom-button").text("Zoom out").on("click",function(){r.grandparent.dispatch("click")}),this.currentLevel=this.display(this.currentData)}},{key:"calculateLayout",value:function(){var t=this,e=0,a=function(t){d3.schemeCategory20[e]||(e=0),t.color=d3.schemeCategory20[e],e++};this.root=d3.hierarchy(this.data,function(t){return t.children}).sum(function(e){return e.children.length?0:e.dollarAmounts[t.dateIndex].dollarAmount}).sort(function(t,e){return e.dollarAmount-t.dollarAmount}).each(a),this.treemap=d3.treemap().size([this.$div.width(),this.$div.height()]).padding(0).round(!1),this.treemap(this.root),this.currentData=this.currentData?this.findHash(this.currentData.data.hash,this.root):this.root,this.state.hash=this.currentData.data.hash}},{key:"display",value:function(t){function e(t,e){e.selectAll(".child").data(function(t){return t.children||[t]}).enter().append("g").attr("class","child").each(function(){d3.select(this);if(void 0!==t.children)for(var e=0;e<t.children.length;e++);}).append("rect").call(a.rect(a.nav))}var a=this,n=this.nav,r=(d3.format(",d"),n.insert("g",".grandparent-g").datum(t).attr("class","depth").on("click",function(t){a.zoneClick.call(this,d3.select(this).datum(),!0,null,a)})),i=r.selectAll("g").data(0===t.children.length?[t]:t.children).enter().append("g");n.grandparent.attr("width","100%").attr("height","20px").style("fill","#eaa").datum(void 0===t.parent?t:t.parent).on("click",function(t){a.zoneClick.call(this,d3.select(this).datum(),!0,null,a)}),i.filter(function(t){return t.children}).classed("children",!0).on("click",function(t){a.zoneClick.call(this,d3.select(this).datum(),!0,null,a)}).each(function(){var t=d3.select(this);t.attr("nodeid",function(){return"1"})}),i.append("rect").attr("class","parent").call(a.rect(a.nav)).style("fill",function(t){return t.color}),e(t,i);this.dateIndex;return i.each(function(){d3.select(this).append("foreignObject").call(a.rect(a.nav)).attr("class","foreignobj").append("xhtml:div").html(function(t){var e='<div class="titleLabel">'+t.data.name+"</div>",n='<div class="valueLabel">$'+a.nFormat(t.value)+"</div>";return e+n}).attr("class","textdiv")}),i}},{key:"open",value:function(t,e){this.zoneClick.call(null,this.currentData,!1,e||1,this)}},{key:"zoneClick",value:function(t,e,a,n){var r=n.nav,i=window.event||i;if(i.preventDefault(),a=a||750,!r.transitioning&&t){if(e&&t.data.hash===n.currentData.data.hash)return void r.grandparent.dispatch("click");n.dateIndex;if(0===t.value)return void n.zoneClick.call(null,t.parent||n.root.data.hash,0,n);r.selectAll("text").remove(),n.currentData=t,n.state.hash=t.data.hash,visualbudget.broadcastStateChange(n.state),r.transitioning=!0;var o=n.display(t),l=n.currentLevel.transition().duration(a),s=o.transition().duration(a);r.x.domain([t.x0,t.x1]),r.y.domain([t.y0,t.y1]),r.style("shape-rendering",null),r.selectAll(".depth").sort(function(t,e){return t.depth-e.depth}),o.selectAll(".foreignobj").style("fill-opacity",0),l.style("opacity",0),l.selectAll(".foreignobj").call(n.rect(r)),s.selectAll(".foreignobj").call(n.rect(r)),l.selectAll("rect").call(n.rect(r)),s.selectAll("rect").call(n.rect(r)),l.remove().on("end",function(){r.style("shape-rendering","crispEdges"),r.transitioning=!1}),n.currentLevel=o}}},{key:"rect",value:function(t){return function(e){e.attr("x",function(e){return t.x(e.x0)}).attr("y",function(e){return t.y(e.y0)}).attr("width",function(e){return t.x(e.x1)-t.x(e.x0)}).attr("height",function(e){return t.y(e.y1)-t.y(e.y0)})}}}]),e}(VbChart),visualbudget=function(t,e,a){return t.initialize=function(a){"undefined"==typeof a&&(a=function(){}),console.log("Initializing VB charts."),t.charts=[];var n=e(".vb-chart");e.when.apply(e,n.map(t.tryToInitializeChart)).then(t.drawAllCharts).then(a)},t.tryToInitializeChart=function(){var a=e(this),n=a.data("vbDatasetUrl");if(n){var r=e.getJSON(n).done(t.setupChartObject(a)).fail(function(t,e,a){var n=e+", "+a;console.log("Request Failed: "+n)});return r}},t.setupChartObject=function(e){return function(a){var n;switch(e.data("vbVis")){case"linechart":n=new VbLineChart(e,a);break;case"treemap":n=new VbTreeMap(e,a);break;case"metric":n=new VbMetric(e,a);break;default:console.log("VB error: Unrecognized chart type.")}t.charts.push(n),console.log("Added chart "+n.atts.hash+" to queue.")}},t.drawAllCharts=function(){t.charts.forEach(function(t,e,a){t.redraw()})},t.broadcastStateChange=function(e){for(var a=0;a<t.charts.length;a++)t.charts[a].setState(e)},t.getChart=function(e){for(var a=null,n=0;n<t.charts.length;n++)if(t.charts[n].atts.hash==e){a=t.charts[n];break}return a},t}(visualbudget||{},jQuery,d3);!function(t,e){e(document).ready(function(){t.initialize()})}(visualbudget,jQuery);